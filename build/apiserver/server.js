!function(e){function t(n){if(s[n])return s[n].exports;var r=s[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var s={};return t.m=e,t.c=s,t.p="",t(0)}([function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var r=s(1),o=s(2),a=n(o),i=s(3),d=n(i),u=s(4),c=n(u),l=s(5),p=n(l),f=s(6),v=n(f),y=s(7),h=s(26);s(42);var m=s(45),g=n(m),E=s(47)(c.default),_=process.env.API_SERVER_PORT;_||(_=3006);var M=(0,d.default)();M.use(function(e,t,s,n){s.headersSent&&n(e),s.status(e.status||_).render("500")}),M.use(a.default.json()),M.use(a.default.urlencoded({extended:!0})),M.use((0,c.default)({name:"snss",secret:process.env.SESSION_SECRET,resave:!0,saveUninitialized:!1,store:new E({client:g.default})})),M.use(y.validateUserSession),M.use((0,p.default)("combined")),M.use("/api/v1",[h.userRoutes,h.recipientRoutes,h.sessionsRoutes,h.postRoutes,h.mediaRoutes]),M.get("/",function(e,t){t.send("Hello - this is the api server. You probably want a more interesting endpoint.")}),process.on("SIGTERM",function(){console.log("Closing server."),M.close()}),M.on("close",function(){console.log("Closing redis."),g.default.quit()});var R=(0,r.Server)(M);R.listen(_,function(e){e?console.log(v.default.red("API Server ERROR on startup: "+e)):console.log(v.default.bold.green("API Server listening on http://localhost:"+_+"."))})},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("chalk")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.requireLogin=t.authenticateUser=t.destroyUserSession=t.createUserSession=t.validateUserSession=void 0;var n=s(8),r=n.models.User,o=function(e,t,s){var n={id:s.id,displayName:s.displayName,email:s.email,userType:s.userType,validated:s.validated};e.session.user=n,e.user=n,t.locals.user=n,t.cookie("snssl","y",{httpOnly:!1})},a=function(e,t,s){e.session&&(e.session.destroy(),t.clearCookie("snssl"))},i=function(e,t,s){e.session&&e.session.user?r.findById(e.session.user.id).then(function(r){r&&(r.userType===n.UserType.BANNED&&(a(e,t,r),s()),o(e,t,r)),s()}):s()},d=function(e,t,s){var n=s.email,a=s.password;if(!n||!a){var i=new Error("Email and password required.");throw i}var d=null;return r.find({where:{email:n}}).then(function(e){if(e)return e;throw new Error("Could not verify account")}).then(function(e){return d=e,e.comparePassword(a)}).then(function(s){if(!s)throw new Error("Could not verify account");return o(e,t,d),d})},u=function(){return function(e,t,s){e&&!e.user?(t.statusMessage="Requires login.",t.status(403).end()):s()}};t.validateUserSession=i,t.createUserSession=o,t.destroyUserSession=a,t.authenticateUser=d,t.requireLogin=u},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.RecipientStatus=t.RecipientType=t.MAX_POST_SEARCH_RETURN_LIMIT=t.PostStatus=t.MediaType=t.UserType=t.models=void 0;var r=s(9),o=n(r),a=s(6),i=n(a),d=s(10),u=n(d),c=s(14),l=n(c),p=s(16),f=n(p),v=s(17),y=n(v),h=s(24),m=n(h),g=s(25),E=n(g),_=s(15),M={development:{username:"mdw",password:null,database:"socialnotsocial",host:"127.0.0.1",dialect:"postgres"},test:{username:"root",password:null,database:"database_test",host:"127.0.0.1",dialect:"postgres"},production:{username:"root",password:null,database:"database_production",host:"127.0.0.1",dialect:"postgres"}},R="production",P=M[R],I=null;I=process.env.DATABASE_URL?new o.default(process.env.DATABASE_URL):new o.default(P.database,P.username,P.password,P);var b={};I.authenticate().then(function(){console.log("Success: Connection to Postgres established .")},function(e){console.log(i.default.red("FAILURE: Unable to connect to the Postgres database:"),e)});var T=(0,u.default)(I,o.default);b[T.name]=T;var N=(0,l.default)(I,o.default);b[N.name]=N;var O=(0,f.default)(I,o.default);b[O.name]=O;var w=(0,y.default)(I,o.default);b[w.name]=w;var S=(0,m.default)(I,o.default);b[S.name]=S;var U=(0,E.default)(I,o.default);b[U.name]=U,Object.keys(b).forEach(function(e){"associate"in b[e]&&b[e].associate(b)}),I.sync().then(function(){console.log("Success: Synced models to database.")},function(e){console.log(i.default.red("FAILURE: An error occurred while creating the table:"),e)}),b.sequelize=I,b.Sequelize=o.default;var A=b;t.models=A,t.UserType=_.UserType,t.MediaType=_.MediaType,t.PostStatus=_.PostStatus,t.MAX_POST_SEARCH_RETURN_LIMIT=_.MAX_POST_SEARCH_RETURN_LIMIT,t.RecipientType=_.RecipientType,t.RecipientStatus=_.RecipientStatus},function(e,t){e.exports=require("sequelize")},function(e,t,s){"use strict";var n=s(11);e.exports=function(e,t){var s=e.define("Apprisal",{id:{type:t.BIGINT,field:"id",primaryKey:!0},deliveredAt:{type:t.DATE,field:"delivered_at"},firstOpenedAt:{type:t.DATE,field:"first_opened_at"},firstViewedAt:{type:t.DATE,field:"first_viewed_at"},canRespond:{type:t.BOOLEAN,defaultValue:!0,field:"can_respond"}},{underscored:!0,paranoid:!0,timestamps:!0,hooks:{beforeValidate:function(e){e.id||(e.id=(0,n.idier)())}},classMethods:{associate:function(e){s.belongsTo(e.Post,{foreignKey:{field:"post_id",allowNull:!1},onDelete:"cascade"}),s.belongsTo(e.Recipient,{foreignKey:{field:"recipient_id",allowNull:!1},onDelete:"cascade"})}}});return s}},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.passGen=t.toNumericId=t.toHumanId=t.idier=void 0;var r=s(12),o=n(r),a=s(13),i=n(a),d=function(){var e=1,t=global.idierSequence;t&&t<1e3&&t>0?(e=t,global.idierSequence+=1):global.idierSequence=e+1;var s=process.env.IDIER_WORKER_ID;s||(s=Math.floor(10*Math.random()));var n=Math.floor(Date.now()/1e3),r=Math.floor(10*Math.random()),o=""+n+s+e+r,a=parseInt(o,10);return a},u=function(e){var t=o.default.encode(e);return t},c=function(e){var t=o.default.decode(e);return t},l=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:12,t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=i.default.generate({length:e,numbers:t,exclude:s,strict:!0});return n};t.idier=d,t.toHumanId=u,t.toNumericId=c,t.passGen=l},function(e,t){e.exports=require("base58")},function(e,t){e.exports=require("generate-password")},function(e,t,s){"use strict";var n=s(11),r=s(15);e.exports=function(e,t){var s=e.define("Media",{id:{type:t.BIGINT,field:"id",primaryKey:!0},url:{type:t.STRING,allowNull:!1,validate:{isUrl:!0}},type:{type:t.ENUM,values:[r.MediaType.PHOTO,r.MediaType.VIDEO],defaultValue:r.MediaType.PHOTO},width:{type:t.INTEGER},height:{type:t.INTEGER},size:{type:t.INTEGER}},{underscored:!0,paranoid:!0,timestamps:!0,hooks:{beforeValidate:function(e){e.id||(e.id=(0,n.idier)())}},classMethods:{associate:function(e){s.belongsTo(e.User),s.belongsToMany(e.Post,{through:"PostMedia"})}}});return s.totalForUser=function(e){return s.findAndCountAll({where:{user_id:e}})},s.updateRecipient=function(e,t,n){return s.findOne({where:{id:e,user_id:t}}).then(function(e){if(!e)return null;var t=e,s=Object.keys(n);return s.forEach(function(e){t[e]=n[e]}),t.save()})},s.deleteMedia=function(e,t){return s.findOne({where:{id:e,user_id:t}}).then(function(e){return e?e.destroy():null})},s}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s={NORMAL:"ut_normal",ADMIN:"ut_admin",CUSTSERVICE:"ut_custservice",BANNED:"ut_banned",DEMO:"ut_demo"},n={VIDEO:"mt_video",PHOTO:"mt_photo"},r={DRAFT:"ps_draft",POSTED:"ps_posted",REMOVED:"ps_removed"},o=100,a={EMAIL:"rt_email",TEXT:"rt_text",POST:"rt_post",FACEBOOK:"rt_facebook"},i={VALIDATING:"rs_validating",ACTIVE:"rs_active",REMOVED:"rs_removed",BOUNCING:"rs_bounding",UNSUBSCRIBED:"rs_unsubscribed"};t.UserType=s,t.MediaType=n,t.PostStatus=r,t.MAX_POST_SEARCH_RETURN_LIMIT=o,t.RecipientType=a,t.RecipientStatus=i},function(e,t,s){"use strict";var n=s(11),r=s(15);e.exports=function(e,t){var s=e.define("Post",{id:{type:t.BIGINT,field:"id",primaryKey:!0},status:{type:t.ENUM,values:[r.PostStatus.DRAFT,r.PostStatus.POSTED,r.PostStatus.REMOVED],defaultValue:r.PostStatus.POSTED},message:{type:t.STRING(5e3),allowNull:!1},edited:{type:t.BOOLEAN}},{underscored:!0,paranoid:!0,timestamps:!0,hooks:{beforeValidate:function(e){e.id||(e.id=(0,n.idier)())}},classMethods:{associate:function(e){s.belongsTo(e.User,{foreignKey:{field:"user_id",allowNull:!1},onDelete:"cascade"}),s.belongsToMany(e.Media,{through:"PostMedia"}),s.hasMany(e.Apprisal)}}});return s.findAllForUser=function(e,t){var s=20;t.limit&&(s=t.limit);var n=0;t.limit&&(n=t.offset);var o=null;t.beforeId&&(o=t.beforeId);var a=[];if(t.includeTables&&(a=t.includeTables),!e)throw new Error("No userId provided");var i={};i.where={user_id:Number(e)},o&&o>0&&(i.id={$lt:o});var d=s;return d>r.MAX_POST_SEARCH_RETURN_LIMIT&&(d=r.MAX_POST_SEARCH_RETURN_LIMIT),i.limit=d,n>0&&(i.offset=n),i.order="id DESC",a&&(i.include=a),this.findAll(i)},s.totalForUser=function(e){return s.findAndCountAll({where:{user_id:e}})},s.updatePost=function(e,t,n){return s.findOne({where:{id:e,user_id:t}}).then(function(e){if(!e)return null;var t=e,s=Object.keys(n);return s.forEach(function(e){t[e]=n[e]}),t.save()})},s.deletePost=function(e,t){return s.findOne({where:{id:e,user_id:t}}).then(function(e){if(!e)return null;var t=e;return t.status=r.PostStatus.REMOVED,t.save()}).then(function(e){return e.destroy()})},s}},function(e,t,s){"use strict";var n=s(11),r=s(18),o=s(21),a=s(15);e.exports=function(e,t){var s=e.define("Recipient",{id:{type:t.BIGINT,field:"id",primaryKey:!0},type:{type:t.ENUM,values:[a.RecipientType.EMAIL,a.RecipientType.TEXT,a.RecipientType.POST,a.RecipientType.FACEBOOK],defaultValue:a.RecipientType.EMAIL},status:{type:t.ENUM,values:[a.RecipientStatus.ACTIVE,a.RecipientStatus.VALIDATING,a.RecipientStatus.REMOVED,a.RecipientStatus.BOUNCING,a.RecipientStatus.UNSUBSCRIBED],defaultValue:a.RecipientStatus.ACTIVE},displayName:{type:t.STRING,allowNull:!1,field:"display_name"},email:{type:t.STRING,allowNull:!1,validate:{isValidEmail:function(e){var t=(0,r.appraiseEmail)(e);if(t.length>0)throw new Error(t.join(" "))}}},accessTokenEncrypted:{type:t.STRING,field:"access_token_hash",allowNull:!1},accessTokenPepper:{type:t.STRING,allowNull:!1,field:"access_token_pepper"},canRespond:{type:t.BOOLEAN,defaultValue:!0,field:"can_respond"},validatedAt:{type:t.DATE,field:"validated_at"},validated:{type:t.BOOLEAN,defaultValue:!1},unsubscribedAt:{type:t.DATE,field:"unsubscribed_at"},unsubscribedReason:{type:t.STRING,field:"unsubscribed_reason"}},{underscored:!0,paranoid:!0,timestamps:!0,indexes:[{unique:!0,fields:["user_id","email"]}],hooks:{beforeValidate:function(e){if(e.id||(e.id=(0,n.idier)()),!e.accessToken){var t=(0,n.passGen)(15,!0,".");console.log("Recipient token: "+t),e.setAccessToken(t)}e.type===a.RecipientType.FACEBOOK&&(e.canRespond=!1)}},instanceMethods:{setAccessToken:function(e){var t=this;if(!e||e.length<15)throw new Error("Invalid token passed to recipient. This is an internal error.");var s=(0,o.aesHash)(e,process.env.TOKEN_ENCRYPT_CURRENT_PEPPER);t.accessTokenEncrypted=s.encrypted,t.accessTokenPepper=s.pepperId},getAccessToken:function(){var e=this;return(0,o.deAesHash)(e.accessTokenEncrypted,e.accessTokenPepper)},toJSON:function(){var e=Object.assign({},this.get());return delete e.accessTokenEncrypted,delete e.accessTokenPepper,delete e.deletedAt,e}},classMethods:{associate:function(e){s.belongsTo(e.User,{foreignKey:{field:"user_id",allowNull:!1},onDelete:"cascade"}),s.hasMany(e.Apprisal)}}});return s.findAllForUser=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments[3];if(!e)throw new Error("No userId provided");var r='"user_id": "'+e+'"',o="";n&&n>0&&(o=", id : {$lt: "+n+"}");var i=t;i>a.MAX_POST_SEARCH_RETURN_LIMIT&&(i=a.MAX_POST_SEARCH_RETURN_LIMIT);var d=', "limit": "'+i+'", ',u="";s>0&&(u=', "offset": "'+s+'", ');var c='"order": "id DESC"',l='{ "where": { '+r+o+" }"+d+u+" "+c+"}",p=JSON.parse(l);return this.findAll(p)},s.totalForUser=function(e){return s.findAndCountAll({where:{user_id:e}})},s.updateRecipient=function(e,t,n){return s.findOne({where:{id:e,user_id:t}}).then(function(e){if(!e)return null;var t=e,s=Object.keys(n);return s.forEach(function(e){t[e]=n[e]}),t.save()})},s.deleteRecipient=function(e,t){return s.findOne({where:{id:e,user_id:t}}).then(function(e){if(!e)return null;var t=e;return t.status=a.RecipientStatus.REMOVED,t.save()}).then(function(e){return e.destroy()})},s}},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.appraisePostMessage=t.appraiseAccountId=t.appraisePasswordErrors=t.appraisePasswordExtra=t.appraisePassword=t.appraiseDisplayName=t.appraiseEmail=t.appraiseThese=void 0;var r=s(19),o=s(20),a=n(o),i=function(e){var t=[];return(0,r.isEmpty)(e)&&t.push("Email address is required."),(0,r.isEmpty)(e)||(0,r.isEmail)(e)||t.push("Email address does not appear to be valid."),t},d=function(e){var t=[];return(0,r.isEmpty)(e)&&t.push("Display name is required."),t},u=function(e){var t=[];if((0,r.isEmpty)(e))t.push("Password is required.");else{var s=a.default.test(e);s.strong||(t=t.concat(s.errors))}return t},c={minLength:0,maxLength:1,repeating:2,needLowercase:3,needUppercase:4,needNumber:5,needCharacter:6},l=function(e){return a.default.test(e)},p=function(e){var t=[];return(0,r.isEmpty)(e)&&t.push("AccountId is required."),t},f=function(e){var t={success:!0,tested:[],errors:{}};if("email"in e){t.tested.push("email");var s=i(e.email);s&&s.length>0&&(t.success=!1,t.errors.email=s)}if("password"in e){t.tested.push("password");var n=u(e.password);n&&n.length>0&&(t.success=!1,t.errors.password=n)}if("displayName"in e){t.tested.push("displayName");var r=d(e.displayName);r&&r.length>0&&(t.success=!1,t.errors.displayName=r)}if("accountId"in e){t.tested.push("accountId");var o=p(e.accountId);o&&o.length>0&&(t.success=!1,t.errors.accountId=o)}return t},v=function(e){var t=[];return e&&!(0,r.isEmpty)(e)||t.push("A message is required."),t};t.appraiseThese=f,t.appraiseEmail=i,t.appraiseDisplayName=d,t.appraisePassword=u,t.appraisePasswordExtra=l,t.appraisePasswordErrors=c,t.appraiseAccountId=p,t.appraisePostMessage=v},function(e,t){e.exports=require("validator")},function(e,t){e.exports=require("owasp-password-strength-test")},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.passwordsMatch=t.aesHash=t.bcryptHash=t.hashPassword=t.deAesHash=t.encryptPassword=void 0;var r=s(22),o=s(23),a=n(o),i=function(e){var t=a.default.createHash("sha512");t.update(e);var s=t.digest("hex");return s},d=function(e){var t=10;return(0,r.hash)(e,t)},u=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:process.env.ACCOUNT_ENCRYPT_CURRENT_PEPPER,s=t;if(!s)throw new Error("Could not encrypt item - no pepper information available");var n=process.env[s];if(!n)throw new Error("Could not encrypt item - no pepper available");var r="aes-256-ctr",o=a.default.createCipher(r,n),i=o.update(e,"utf8","hex");return i+=o.final("hex"),{encrypted:i,pepperId:s}},c=function(e){return Promise.resolve(e).then(i).then(d).then(u)},l=function(e,t){var s=process.env[t];if(!s)return new Error("Pepper not found.");var n="aes-256-ctr",r=a.default.createDecipher(n,s),o=r.update(e,"hex","utf8");return o+=r.final("utf8")},p=function(e,t,s){var n=i(e),o=l(t,s);return(0,r.compare)(n,o)};t.encryptPassword=c,t.deAesHash=l,t.hashPassword=i,t.bcryptHash=d,t.aesHash=u,t.passwordsMatch=p},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("crypto")},function(e,t,s){"use strict";var n=s(21),r=s(18),o=s(11),a=s(15);e.exports=function(e,t){var s=e.define("User",{id:{type:t.BIGINT,field:"id",primaryKey:!0},userType:{field:"user_type",type:t.ENUM,values:[a.UserType.NORMAL,a.UserType.ADMIN,a.UserType.CUSTSERVICE,a.UserType.BANNED],defaultValue:a.UserType.NORMAL,allowNull:!1},displayName:{field:"display_name",type:t.STRING,allowNull:!1,validate:{isValidDisplayName:function(e){var t=(0,r.appraiseDisplayName)(e);if(t.length>0)throw new Error(t.join(" "))}}},email:{type:t.STRING,allowNull:!1,validate:{isValidEmail:function(e){var t=(0,r.appraiseEmail)(e);if(t.length>0)throw new Error(t.join(" "))}},unique:!0},encryptedPasswordHash:{field:"encrypted_password_hash",type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},encryptedPasswordPepperId:{field:"encrypted_password_pepperId",type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},validatedAt:{type:t.DATE,field:"validated_at"},validated:{type:t.BOOLEAN,defaultValue:!1}},{underscored:!0,paranoid:!0,hooks:{beforeValidate:function(e){e.id||(e.id=(0,o.idier)())}},instanceMethods:{setPassword:function(e){var t=this;return Promise.resolve((0,r.appraisePassword)(e)).then(function(t){if(t.length>0)throw new Error(t.join(", "));return e}).then(function(e){return(0,n.encryptPassword)(e)}).then(function(e){t.encryptedPasswordHash=e.encrypted,t.encryptedPasswordPepperId=e.pepperId}).catch(function(e){throw e})},toJSON:function(){var e=Object.assign({},this.get());return delete e.encryptedPasswordHash,delete e.encryptedPasswordPepperId,delete e.deletedAt,e},toProfile:function(){var e=Object.assign({},this.get());return delete e.encryptedPasswordHash,delete e.encryptedPasswordPepperId,delete e.email,delete e.deletedAt,e},comparePassword:function(e){return(0,n.passwordsMatch)(e,this.encryptedPasswordHash,this.encryptedPasswordPepperId)},canActOnBehalfOf:function(e){return this.userType===a.UserType.ADMIN||this.userType===a.UserType.CUSTSERVICE}},classMethods:{associate:function(e){s.hasMany(e.Post),s.hasMany(e.Recipient),s.hasMany(e.Media),s.hasMany(e.UserValidation)}}});return s}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(11),r=function(e,t){var s=e.define("UserValidation",{id:{type:t.BIGINT,field:"id",primaryKey:!0},email:{type:t.STRING,allowNull:!1},deliveredAt:{type:t.DATE,field:"delivered_at"},visitedAt:{type:t.DATE,field:"visited_at"}},{underscored:!0,paranoid:!0,timestamps:!0,hooks:{beforeValidate:function(e){e.id||(e.id=(0,n.idier)())}},classMethods:{associate:function(e){s.belongsTo(e.User)}}});return s};t.default=r},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(27);Object.keys(n).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}})});var r=s(30);Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}})});var o=s(33);Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}})});var a=s(36);Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}})});var i=s(39);Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}})})},function(e,t,s){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.UserController=t.userRoutes=void 0;var o=s(28),a=r(o),i=s(29),d=n(i);t.userRoutes=a.default,t.UserController=d},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(3),r=s(7),o=s(29),a=new n.Router;a.route("/users").post(o.addUserEndpoint),a.get("/users",(0,r.requireLogin)(),o.getUserInfoEndpoint),a.put("/users",(0,r.requireLogin)(),o.updateUserEndpoint),a.put("/passwords",(0,r.requireLogin)(),o.updatePasswordEndpoint),t.default=a},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updatePasswordEndpoint=t.updateUserEndpoint=t.getUserInfoEndpoint=t.addUserEndpoint=void 0;var n=s(7),r=s(8),o=r.models.User,a=function(e){var t=e.user,s=e.body.onBehalfOfId;return s&&s.length>0&&t&&t.canActOnBehalfOf(s)?s:e.user&&e.user.id?e.user.id:null},i=function(e,t){console.log("user"),console.dir(r.models);var s=e.body,a=s.email,i=s.password,d=s.displayName,u=o.build({email:a,displayName:d});u.setPassword(i).then(function(){return u.save()}).then(function(s){console.log("Created User"),(0,n.createUserSession)(e,t,s),console.log("Finished login");var r=s.toJSON();t.status(201).json({success:!0,message:"Successfully Registered",user:r})}).catch(function(s){if((0,n.destroyUserSession)(e,t),console.log(s),console.dir(s),11e3===s.code)return t.statusMessage="User with that email already exists",void t.status(409).end();var r="User could not be created.";s.message&&(r=s.message.replace(/(\r\n|\n|\r)/gm," ")),t.statusMessage=r,t.status(422).send(JSON.stringify({errors:s.message}))})},d=function(e,t){var s=a(e);return s?void o.findById(s).then(function(e){var s=e.toJSON();t.status(201).json({success:!0,user:s})}).catch(function(e){t.statusMessage=e.message,t.status(422).end()}):t.status(422).json({success:!1,message:"Not logged in."})},u=function(e,t){var s=a(e);if(!s)return t.status(422).json({success:!1,message:"Not logged in."});var n=e.body,r=n.email,i=n.displayName;o.findById(s).then(function(e){var t=e;return r&&r.length>0&&(t.email=r),i&&i.length>0&&(t.displayName=i),t.save()}).then(function(e){var s=e.toJSON();t.status(200).json({success:!0,user:s})}).catch(function(e){t.statusMessage=e.message,t.status(422).end()})},c=function(e,t){var s=a(e);if(!s)return t.status(422).json({success:!1,message:"Not logged in."});var n=e.body,r=n.password,i=n.newPassword,d=null;o.findById(s).then(function(e){return d=e,e.comparePassword(r)}).then(function(e){if(!e)throw new Error("Could not verify user");return d}).then(function(){return d.setPassword(i)}).then(function(){return d.save()}).then(function(){t.status(200).end()}).catch(function(e){t.statusMessage=e.message,t.status(422).end()})};t.addUserEndpoint=i,t.getUserInfoEndpoint=d,t.updateUserEndpoint=u,t.updatePasswordEndpoint=c},function(e,t,s){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.RecipientController=t.recipientRoutes=void 0;var o=s(31),a=r(o),i=s(32),d=n(i);t.recipientRoutes=a.default,t.RecipientController=d},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(3),r=s(7),o=s(32),a=new n.Router;a.get("/recipients",(0,r.requireLogin)(),o.getRecipientsEndpoint),a.post("/recipients",(0,r.requireLogin)(),o.addRecipientEndpoint),a.put("/recipients/:recipientId",(0,r.requireLogin)(),o.updateRecipientEndpoint),a.delete("/recipients/:recipientId",(0,r.requireLogin)(),o.removeRecipientEndpoint),t.default=a},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeRecipientEndpoint=t.updateRecipientEndpoint=t.addRecipientEndpoint=t.getRecipientsEndpoint=void 0;var n=s(8),r=s(33),o=n.models.Recipient,a=function(e,t){var s=(0,r.proxyUserId)(e);s||(t.statusMessage="No user provided",t.status(422).end()),o.findAllForUser(s).then(function(e){var s=e.map(function(e){return e.toJSON()});t.status(200).json({success:!0,recipients:s})}).catch(function(e){t.statusMessage=e.message,t.status(404).end()})},i=function(e,t){var s=e.body,n=s.email,a=s.displayName,i=(0,r.proxyUserId)(e),d=o.build({email:n,displayName:a,user_id:i});d.save().then(function(e){t.status(201).json({success:!0,message:"Successfully created recipient",recipient:e.toJSON()})}).catch(function(e){console.log("Recipient creation error: "),console.dir(e);var s="Recipient could not be created.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})},d=function(e,t){var s=(0,r.proxyUserId)(e);s||(t.statusMessage="No user provided",t.status(422).end());var n=e.params.recipientId;e.body.recipientId&&(n=e.body.recipientId);var a=e.body,i=a.email,d=a.displayName,u=a.status;n||(t.statusMessage="No recipientId provided",t.status(422).end());var c={};i&&i.length>0&&(c.email=i),d&&d.length>0&&(c.displayName=d),u&&u.length>0&&(c.status=u),0===Object.keys(c).length&&(t.statusMessage="Nothing to update",t.status(422).end()),o.updateRecipient(n,s,c).then(function(e){return e?void t.status(201).json({success:!0,message:"Successfully updated recipient",recipient:e.toJSON()}):(t.statusMessage="Recipient was not found.",void t.status(404).end())}).catch(function(e){console.log("Recipient update error: "),console.dir(e);var s="Recipient could not be updated.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})},u=function(e,t){var s=(0,r.proxyUserId)(e);s||(t.statusMessage="No user provided",t.status(422).end());var n=e.params.recipientId;e.body.recipientId&&(n=e.body.recipientId),n||(t.statusMessage="No recipientId provided.",t.status(422).end()),o.deleteRecipient(n,s).then(function(e){return e?void t.status(204).end():(t.statusMessage="Recipient was not found.",void t.status(404).end())}).catch(function(e){var s="Recipient could not be removed.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})};t.getRecipientsEndpoint=a,t.addRecipientEndpoint=i,t.updateRecipientEndpoint=d,t.removeRecipientEndpoint=u},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.proxyUserId=t.requireLogin=t.authenticateUser=t.destroyUserSession=t.createUserSession=t.validateUserSession=t.sessionsRoutes=void 0;var r=s(34),o=n(r),a=s(35),i=n(a),d=s(7);t.sessionsRoutes=o.default,t.validateUserSession=d.validateUserSession,t.createUserSession=d.createUserSession,t.destroyUserSession=d.destroyUserSession,t.authenticateUser=d.authenticateUser,t.requireLogin=d.requireLogin,t.proxyUserId=i.default},function(e,t,s){"use strict";function n(e,t){var s=e.body;(0,o.authenticateUser)(e,t,s).then(function(e){t.status(201).json({success:!0,message:"Logged in",user:e})}).catch(function(e){console.log(e),t.statusMessage="Could not log in with that email and password combination.",t.status(422).end()})}Object.defineProperty(t,"__esModule",{value:!0});var r=s(3),o=s(7),a=new r.Router;a.route("/sessions").post(n),a.route("/sessions").delete(function(e,t){(0,o.destroyUserSession)(e,t),t.status(204).end()}),a.route("/sessions").get(function(e,t){return e.user?void t.status(204).end():void t.status(403).end()}),t.default=a},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(e){var t=e.user,s=e.body.onBehalfOfId;return s&&s.length>0&&t&&t.canActOnBehalfOf(s)?s:e.user&&e.user.id?e.user.id:null};t.default=s},function(e,t,s){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.PostController=t.postRoutes=void 0;var o=s(37),a=r(o),i=s(38),d=n(i);t.postRoutes=a.default,t.PostController=d},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(3),r=s(38),o=s(7),a=new n.Router;a.get("/posts",(0,o.requireLogin)(),r.getPostsEndpoint),a.post("/posts",(0,o.requireLogin)(),r.addPostEndpoint),a.put("/posts/:postId",(0,o.requireLogin)(),r.updatePostEndpoint),a.delete("/posts/:postId",(0,o.requireLogin)(),r.removePostEndpoint),t.default=a},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removePostEndpoint=t.updatePostEndpoint=t.addPostEndpoint=t.getPostsEndpoint=void 0;var n=s(8),r=s(33),o=n.models.Post,a=n.models.Media,i=n.models.Apprisal,d=function(e,t){var s=(0,r.proxyUserId)(e);s||(t.statusMessage="No user provided",t.status(422).end()),o.findAllForUser(s,{includeTables:[{model:a,attributes:["url"],through:{attributes:[]}},{model:i}]}).then(function(e){var s=e.map(function(e){return e.toJSON()});t.status(200).json({success:!0,posts:s})}).catch(function(e){t.statusMessage=e.message,t.status(404).end()})},u=function(e,t){var s=(0,r.proxyUserId)(e);s||(t.statusMessage="No user provided",t.status(422).end());var n=e.body,i=n.message,d=n.status,u=n.mediaIds,c=o.build({message:i,status:d,user_id:s}),l=null;c.save().then(function(e){return l=e.id,console.log("created item"),console.dir(e),u&&u.length>0?e.setMedia(u):(console.log("Got here, but maybe should not have"),e)}).then(function(){return console.log("We set media, now for find and associate"),o.find({where:{id:l},include:[a]})}).then(function(e){console.log("created item"),console.dir(JSON.stringify(e));var s=e.toJSON();t.status(201).json({success:!0,message:"Successfully created post",post:s})}).catch(function(e){var s="Post could not be created.";11e3===e.code?s="Post already exists":e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})},c=function(e,t){var s=(0,r.proxyUserId)(e);s||(t.statusMessage="No user provided",t.status(422).end());var n=e.params.postId;e.body.postId&&(n=e.body.postId),n||(t.statusMessage="No post id provided",t.status(422).end());var a=e.body,i=a.message,d=a.mediaIds,u=a.status,c={};i&&i.length>0&&(c.message=i),u&&u.length>0&&(c.status=u),d&&d.length>0&&(c.mediaIds=d),0===Object.keys(c).length&&(t.statusMessage="Nothing to update",t.status(422).end()),o.updatePost(n,s,c).then(function(e){return e?void t.status(200).json({success:!0,message:"Successfully updated post",post:e.toJSON()}):(t.statusMessage="Post was not found.",void t.status(404).end())}).catch(function(e){console.dir(e);var s="Post could not be updated.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})},l=function(e,t){var s=(0,r.proxyUserId)(e);s||(t.statusMessage="No user provided",t.status(422).end());var n=e.params.postId;e.body.postId&&(n=e.body.postId),n||(t.statusMessage="No postId provided.",t.status(422).end()),o.deletePost(n,s).then(function(e){return e?void t.status(204).end():(t.statusMessage="Post was not found.",void t.status(404).end())}).catch(function(e){var s="Post could not be removed.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})};t.getPostsEndpoint=d,t.addPostEndpoint=u,t.updatePostEndpoint=c,t.removePostEndpoint=l},function(e,t,s){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.MediaController=t.mediaRoutes=void 0;var o=s(40),a=r(o),i=s(41),d=n(i);t.mediaRoutes=a.default,t.MediaController=d},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(3),r=s(7),o=s(41),a=new n.Router;a.get("/media",(0,r.requireLogin)(),o.getMediaEndpoint),a.post("/media",(0,r.requireLogin)(),o.addMediumEndpoint),a.put("/media/:mediaId",(0,r.requireLogin)(),o.updateMediumEndpoint),a.delete("/media/:mediaId",(0,r.requireLogin)(),o.removeMediumEndpoint),t.default=a},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeMediumEndpoint=t.updateMediumEndpoint=t.addMediumEndpoint=t.getMediaEndpoint=void 0;var n=s(8),r=s(33),o=n.models.Media,a=function(e,t){var s=(0,r.proxyUserId)(e);s||(t.statusMessage="No user provided",t.status(422).end()),o.findAllForUser(s).then(function(e){var s=e.map(function(e){return e.toJSON()});t.status(200).json({success:!0,media:s})}).catch(function(e){t.statusMessage=e.message,t.status(404).end()})},i=function(e,t){var s=e.body,n=s.url,a=s.type,i=(0,r.proxyUserId)(e),d=o.build({url:n,type:a,user_id:i});d.save().then(function(e){
t.status(201).json({success:!0,message:"Successfully created media item",media:e.toJSON()})}).catch(function(e){console.log("Media item creation error: "),console.dir(e);var s="Media item could not be created.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})},d=function(e,t){var s=(0,r.proxyUserId)(e);s||(t.statusMessage="No user provided",t.status(422).end());var n=e.params.mediaId;e.body.mediaId&&(n=e.body.mediaId);var a=e.body,i=a.url,d=a.type;n||(t.statusMessage="No mediaId provided",t.status(422).end());var u={};i&&i.length>0&&(u.url=i),d&&d.length>0&&(u.type=d),0===Object.keys(u).length&&(t.statusMessage="Nothing to update",t.status(422).end()),o.updateMedia(n,s,u).then(function(e){return e?void t.status(201).json({success:!0,message:"Successfully updated media",media:e.toJSON()}):(t.statusMessage="Media was not found.",void t.status(404).end())}).catch(function(e){console.log("Media update error: "),console.dir(e);var s="Media could not be updated.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})},u=function(e,t){var s=(0,r.proxyUserId)(e);s||(t.statusMessage="No user provided",t.status(422).end());var n=e.params.mediaId;e.body.mediaId&&(n=e.body.mediaId),n||(t.statusMessage="No mediaId provided.",t.status(422).end()),o.deleteMedia(n,s).then(function(e){return e?void t.status(204).end():(t.statusMessage="Media was not found.",void t.status(404).end())}).catch(function(e){var s="Media could not be removed.";e.message&&(s=e.message),t.statusMessage=s,t.status(422).end()})};t.getMediaEndpoint=a,t.addMediumEndpoint=i,t.updateMediumEndpoint=d,t.removeMediumEndpoint=u},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}var r=s(43),o=(n(r),s(44)),a=n(o);console.log("Environment: did NOT load environment variables from .env for production. This is not a problem if you define your environment variables outside of the file system as you should."),(0,a.default)(["REDIS_URL","DATABASE_URL","MAIN_SERVER_PORT","ACCOUNT_PEPPER_1","ACCOUNT_ENCRYPT_CURRENT_PEPPER","IDIER_WORKER_ID","TOKEN_PEPPER_1","TOKEN_ENCRYPT_CURRENT_PEPPER","SESSION_SECRET"])},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("require-environment-variables")},function(e,t,s){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var r=s(46),o=n(r),a=process.env.REDIS_URL,i=o.default.createClient(a);i.on("error",function(e){console.log("Redis connection error "+e)}),t.default=i},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("connect-redis")}]);
//# sourceMappingURL=server.js.map