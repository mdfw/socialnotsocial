!function(e){function t(s){if(n[s])return n[s].exports;var o=n[s]={exports:{},id:s,loaded:!1};return e[s].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}var o=n(1),r=n(2),a=s(r),i=n(3),u=s(i),c=n(4),d=s(c),p=n(5),l=s(p),f=n(6),v=s(f),h=n(7);n(35);var m=n(38),g=s(m),y=n(39),I=s(y),P=n(41)(d.default),E=process.env.API_SERVER_PORT;E||(E=3006);var _=(0,u.default)();_.use(function(e,t,n,s){n.headersSent&&s(e),n.status(e.status||E).render("500")}),_.use(a.default.json()),_.use(a.default.urlencoded({extended:!0})),_.use((0,d.default)({name:"snss",secret:"MmyWTLNNsTi15LYHz8FP",resave:!0,saveUninitialized:!1,store:new P({client:I.default})})),_.use(v.default.initialize()),_.use(v.default.session()),_.use((0,l.default)("combined")),_.use("/api/v1",[h.accountRoutes,h.recipientRoutes,h.authenticationRoutes,h.postRoutes]),_.get("/",function(e,t){t.send("Hello - this is the api server. You probably want a more interesting endpoint.")}),process.on("SIGTERM",function(){console.log("Closing server."),_.close()}),_.on("close",function(){console.log("Closing redis."),I.default.quit(),g.default.close()});var O=(0,o.Server)(_);O.listen(E,function(e){e?console.log("API Server ERROR on startup: "+e):console.log("API Server listening on http://localhost:"+E+".")})},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("passport")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=n(8);Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}})});var o=n(27);Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}})});var r=n(22);Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}})});var a=n(31);Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}})})},function(e,t,n){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.AccountController=t.Account=t.accountRoutes=void 0;var r=n(9),a=o(r),i=n(11),u=o(i),c=n(10),d=s(c);t.accountRoutes=a.default,t.Account=u.default,t.AccountController=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=n(3),o=n(10),r=n(22),a=new s.Router;a.route("/account").post(o.addAccountEndpoint),a.get("/account",(0,r.ensureLoggedIn)(),o.getAccountInfoEndpoint),t.default=a},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.getAccountInfoEndpoint=t.updateAccountEndpoint=t.addAccountEndpoint=void 0;var o=n(11),r=s(o),a=function(e){var t=e.user,n=e.body.onBehalfOfId;return n&&n.length>0&&t&&t.canActOnBehalfOf(n)?n:e.user&&e.user.accountId?e.user.accountId:null},i=function(e,t){var n=e.body,s=n.email,o=n.password,a=n.displayName,i=new r.default({email:s,password:o,displayName:a});i.setPassword(o).then(function(){return i.save()}).then(function(e){var n=e.toJSON();t.status(201).json({success:!0,message:"Successfully Registered",account:n})}).catch(function(e){if(11e3===e.code)return t.statusMessage="Account with that email already exists",void t.status(409).end();var n="Account could not be created.";e.message&&(n=e.message),t.statusMessage=n,t.status(422).end()})},u=function(e,t){var n=a(e);return n?void r.default.findOneAccount(n,!1).then(function(e){var n=e.toJSON();t.status(201).json({success:!0,account:n})}).catch(function(e){t.statusMessage=e.message,t.status(422).end()}):t.status(422).json({success:!1,message:"No accountId provided"})},c=function(e,t){t.status(418).json({message:"Brewing"})};t.addAccountEndpoint=i,t.updateAccountEndpoint=c,t.getAccountInfoEndpoint=u},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(12),r=s(o),a=n(13),i=n(16),u=n(19),c={NORMAL:"normal",ADMIN:"admin",CUSTSERVICE:"custservice",BANNED:"banned"},d=new o.Schema({accountId:{type:o.Schema.Types.Number,unique:!0,required:!0},accountType:{type:String,enum:[c.NORMAL,c.ADMIN,c.CUSTSERVICE,c.BANNED],default:c.NORMAL},email:{type:String,trim:!0,unique:!0,lowercase:!0},displayName:{type:String,trim:!0},encryptedPasswordHash:{type:String,trim:!0,required:!0},encryptedPasswordPepperId:{type:String},dateCreated:{type:Date,default:Date.now},dateAccountValidated:{type:Date},dateUpdated:{type:Date,default:Date.now}});d.set("toJSON",{transform:function(e,t){return delete t.encryptedPasswordHash,delete t.passwordEncryptionPepperId,t}}),d.set("toJSON",{transform:function(e,t){return{displayName:t.displayName,email:t.email,dateCreated:t.dateCreated,dateAccountValidated:t.dateAccountValidated,dateUpdated:t.dateUpdated,accountId:t.accountId,accountType:t.accountType}}}),d.set("toObject",{transform:function(e,t){return delete t.encryptedPasswordHash,delete t.passwordEncryptionPepperId,t}}),d.methods.setPassword=function(e){var t=this;return Promise.resolve((0,u.appraisePassword)(e)).then(function(t){if(t.length>0)throw new Error(t.join(", "));return e}).then(function(e){return(0,a.encryptPassword)(e)}).then(function(e){console.log("Got encrypted value: "),console.dir(e),t.encryptedPasswordHash=e.encrypted,t.encryptedPasswordPepperId=e.pepperId}).catch(function(e){throw e})},d.pre("validate",function(e){this.accountId||(this.accountId=(0,i.idier)()),e()}),d.pre("save",!0,function(e,t){this.dateUpdated=new Date,e(),t()}),d.pre("save",!0,function(e,t){var n=[],s=(0,u.appraiseEmail)(this.email);s.length>0&&(this.invalidate("email",s.join(", ")),n.push(s.join(", ")));var o=(0,u.appraiseDisplayName)(this.displayName);o.length>0&&(this.invalidate("displayName",o.join(", ")),n.push(o.join(" "))),n.length>0&&t(new Error(n.join(" "))),e(),t()}),d.methods.comparePassword=function(e){return(0,a.passwordsMatch)(e,this.encryptedPasswordHash,this.encryptedPasswordPepperId)},d.methods.canActOnBehalfOf=function(e){return this.accountType===c.ADMIN||this.accountType===c.CUSTSERVICE},d.statics.findOneAccount=function(e){return this.findOne({accountId:e}).exec()},d.statics.findOneByEmail=function(e){return this.findOne({email:e}).exec()};var p=r.default.model("Account",d);t.default=p},function(e,t){e.exports=require("mongoose")},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.passwordsMatch=t.aesHash=t.bcryptHash=t.hashPassword=t.deAesHash=t.encryptPassword=void 0;var o=n(14),r=n(15),a=s(r),i=function(e){var t=a.default.createHash("sha512");t.update(e);var n=t.digest("hex");return n},u=function(e){var t=10;return(0,o.hash)(e,t)},c=function(e){var t=process.env.ACCOUNT_ENCRYPT_CURRENT_PEPPER,n=process.env[t],s="aes-256-ctr",o=a.default.createCipher(s,n),r=o.update(e,"utf8","hex");return r+=o.final("hex"),{encrypted:r,pepperId:t}},d=function(e){return Promise.resolve(e).then(i).then(u).then(c)},p=function(e,t){var n=process.env[t];if(!n)return new Error("Pepper not found.");var s="aes-256-ctr",o=a.default.createDecipher(s,n),r=o.update(e,"hex","utf8");return r+=o.final("utf8")},l=function(e,t,n){var s=i(e),r=p(t,n);return(0,o.compare)(s,r)};t.encryptPassword=d,t.deAesHash=p,t.hashPassword=i,t.bcryptHash=u,t.aesHash=c,t.passwordsMatch=l},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("crypto")},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.passGen=t.toNumericId=t.toHumanId=t.idier=void 0;var o=n(17),r=s(o),a=n(18),i=s(a),u=function(){var e=1,t=global.idierSequence;t&&t<1e3&&t>0?(e=t,global.idierSequence+=1):global.idierSequence=e+1;var n=process.env.IDIER_WORKER_ID;n||(n=Math.floor(10*Math.random()));var s=Math.floor(Date.now()/1e3),o=Math.floor(10*Math.random()),r=""+s+n+e+o,a=parseInt(r,10);return a},c=function(e){var t=r.default.encode(e);return t},d=function(e){var t=r.default.decode(e);return t},p=function(){var e=i.default.generate({length:12,numbers:!0});return e};t.idier=u,t.toHumanId=c,t.toNumericId=d,t.passGen=p},function(e,t){e.exports=require("base58")},function(e,t){e.exports=require("generate-password")},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.appraisePostMessage=t.appraisePostSubject=t.appraiseAccountId=t.appraisePasswordErrors=t.appraisePasswordExtra=t.appraisePassword=t.appraiseDisplayName=t.appraiseEmail=t.appraiseThese=void 0;var o=n(20),r=n(21),a=s(r),i=function(e){var t=[];return(0,o.isEmpty)(e)&&t.push("Email address is required."),(0,o.isEmpty)(e)||(0,o.isEmail)(e)||t.push("Email address does not appear to be valid."),t},u=function(e){var t=[];return(0,o.isEmpty)(e)&&t.push("Display name is required."),t},c=function(e){var t=[];if((0,o.isEmpty)(e))t.push("Password is required.");else{var n=a.default.test(e);n.strong||(t=t.concat(n.errors))}return t},d={minLength:0,maxLength:1,repeating:2,needLowercase:3,needUppercase:4,needNumber:5,needCharacter:6},p=function(e){return a.default.test(e)},l=function(e){var t=[];return(0,o.isEmpty)(e)&&t.push("AccountId is required."),t},f=function(e){var t={success:!0,tested:[],errors:{}};if("email"in e){t.tested.push("email");var n=i(e.email);n&&n.length>0&&(t.success=!1,t.errors.email=n)}if("password"in e){t.tested.push("password");var s=c(e.password);s&&s.length>0&&(t.success=!1,t.errors.password=s)}if("displayName"in e){t.tested.push("displayName");var o=u(e.displayName);o&&o.length>0&&(t.success=!1,t.errors.displayName=o)}if("accountId"in e){t.tested.push("accountId");var r=l(e.accountId);r&&r.length>0&&(t.success=!1,t.errors.accountId=r)}return t},v=function(e){var t=[];return e&&!(0,o.isEmpty)(e)||t.push("A message is required."),t},h=function(e){return[]};t.appraiseThese=f,t.appraiseEmail=i,t.appraiseDisplayName=u,t.appraisePassword=c,t.appraisePasswordExtra=p,t.appraisePasswordErrors=d,t.appraiseAccountId=l,t.appraisePostSubject=h,t.appraisePostMessage=v},function(e,t){e.exports=require("validator")},function(e,t){e.exports=require("owasp-password-strength-test")},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.authenticationRoutes=t.ensureLoggedIn=void 0,n(23);var o=n(25),r=s(o),a=n(26),i=s(a);t.ensureLoggedIn=r.default,t.authenticationRoutes=i.default},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}var o=n(24),r=n(6),a=s(r),i=n(11),u=s(i);a.default.use(new o.Strategy({usernameField:"email",passwordField:"password"},function(e,t,n){var s=null;u.default.findOneByEmail(e).then(function(e){return s=e,e.comparePassword(t)}).then(function(e){if(!e)throw new Error("Could not verify account");return s}).then(function(e){n(null,e)}).catch(function(e){return console.log("Passport authentication failed: Unknown error: "+e),n(null,!1,{message:"Could not authenticate account"})})})),a.default.serializeUser(function(e,t){t(null,e.accountId)}),a.default.deserializeUser(function(e,t){u.default.findOneAccount(e).then(function(e){return t(null,e)}).catch(function(e){return t(e)})})},function(e,t){e.exports=require("passport-local")},function(e,t){"use strict";function n(e){var t="/login";"string"==typeof e?t=e:e&&e.redirectTo&&e.redirectTo.length>0&&(t=e.redirectTo);var n=e||{},s=void 0===n.setReturnTo||e.setReturnTo;return function(e,n,o){return e.isAuthenticated&&e.isAuthenticated()?void o():(s&&e.session&&(e.session.returnTo=e.originalUrl||e.url),n.redirect(t))}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=n},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function o(e,t,n){i.default.authenticate("local",function(s,o){!s&&o||(t.statusMessage="Could not log in with that email and password combination.",t.status(422).end()),e.logIn(o,function(e){return e?n(e):(t.cookie("snssl","y",{httpOnly:!1}),void t.status(201).json({success:!0,message:"Logged in",account:o}))})})(e,t,n)}Object.defineProperty(t,"__esModule",{value:!0});var r=n(3),a=n(6),i=s(a),u=new r.Router;u.route("/sessions").post(o),u.route("/sessions").delete(function(e,t){e.session.destroy(),e.logout(),t.clearCookie("snssl"),t.status(204).end()}),u.route("/sessions").get(function(e,t){e.isAuthenticated&&e.isAuthenticated()||t.status(204).end(),t.status(403).end()}),t.default=u},function(e,t,n){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.RecipientController=t.Recipient=t.recipientRoutes=void 0;var r=n(28),a=o(r),i=n(30),u=o(i),c=n(29),d=s(c);t.recipientRoutes=a.default,t.Recipient=u.default,t.RecipientController=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=n(3),o=n(29),r=n(22),a=new s.Router;a.get("/recipients",(0,r.ensureLoggedIn)(),o.getRecipientsEndpoint),a.post("/recipients",(0,r.ensureLoggedIn)(),o.addRecipientEndpoint),a.put("/recipients/:recipientId",(0,r.ensureLoggedIn)(),o.updateRecipientEndpoint),a.delete("/recipients/:recipientId",(0,r.ensureLoggedIn)(),o.removeRecipientEndpoint),t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removeRecipientEndpoint=t.updateRecipientEndpoint=t.addRecipientEndpoint=t.getRecipientsEndpoint=void 0;var s=n(30),o=function(e){var t=e.user,n=e.body.onBehalfOfId;return n&&n.length>0&&t&&t.canActOnBehalfOf(n)?n:e.user.accountId},r=function(e,t){var n=o(e);return n?void s.Recipient.findAllForId(n,!1).then(function(e){var n=e.map(function(e){return e.toJSON()});console.log("Found these recipients"),console.dir(e),t.status(201).json({success:!0,recipients:n})}).catch(function(e){t.status(422).json({success:!1,message:e.message})}):t.status(422).json({success:!1,message:"No accountId provided"})},a=function(e,t){var n=e.body,r=n.email,a=n.displayName,i=o(e),u=new s.Recipient({email:r,displayName:a,ownerAccountId:i});console.log("Heres the new recipient"),console.dir(u),u.save().then(function(e){console.log("Created new recipient: "),console.dir(e),console.dir(e.toObject()),t.status(201).json({success:!0,message:"Successfully created recipient",recipient:e.toJSON()})}).catch(function(e){console.log("Recipient creation error: "),console.dir(e);var n="Recipient could not be created.";11e3===e.code?n="Recipient already exists":e.message&&(n=e.message),t.status(422).json({success:!1,messages:n})})},i=function(e,t){var n=e.params.recipientId;e.body.recipientId&&(n=e.body.recipientId);var r=e.body,a=r.email,i=r.displayName,u=r.status;n||t.status(422).json({success:!1,messages:"No recipientId provided."});var c=o(e),d={};a&&a.length>0&&(d.email=a),i&&i.length>0&&(d.displayName=i),u&&u.length>0&&(d.status=u),0===Object.keys(d).length&&t.status(422).json({success:!1,messages:"Nothing to update."}),s.Recipient.update(n,c,d).then(function(e){console.log("Updated recipient: "),console.dir(e),console.dir(e.toObject()),t.status(201).json({success:!0,message:"Successfully updated recipient",recipient:e.toJSON()})}).catch(function(e){console.log("Recipient update error: "),console.dir(e);var n="Recipient could not be updated.";e.message&&(n=e.message),t.status(422).json({success:!1,messages:n})})},u=function(e,t){var n=e.params.recipientId;e.body.recipientId&&(n=e.body.recipientId),n||t.status(422).json({success:!1,messages:"No recipientId provided."});var r=o(e);s.Recipient.update(n,r,{status:s.RecipientStatus.REMOVED}).then(function(e){console.log("Updated recipient: "),console.dir(e),console.dir(e.toObject()),t.status(201).json({success:!0,message:"Successfully removed recipient"})}).catch(function(e){console.log("Recipient removal error: "),console.dir(e);var n="Recipient could not be removed.";e.message&&(n=e.message),t.status(422).json({success:!1,messages:n})})};t.getRecipientsEndpoint=r,t.addRecipientEndpoint=a,t.updateRecipientEndpoint=i,t.removeRecipientEndpoint=u},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.RecipientStatus=t.Recipient=void 0;var o=n(12),r=s(o),a=n(19),i=n(16),u={VALIDATING:"validating",ACTIVE:"active",REMOVED:"removed",BOUNCING:"bouncing",UNSUBSCRIBED:"unsubscribed"},c=new o.Schema({status:{type:o.Schema.Types.String,default:u.ACTIVE,enum:[u.VALIDATING,u.ACTIVE,u.REMOVED,u.BOUNCING,u.UNSUBSCRIBED]},recipientId:{type:o.Schema.Types.Number,unique:!0,required:!0},ownerAccountId:{type:o.Schema.Types.Number,required:!0,index:!0},email:{type:String,trim:!0},phoneNumber:{type:String},phoneType:{type:String},displayName:{type:String,trim:!0},dateCreated:{type:Date,default:Date.now},dateUpdated:{type:Date,default:Date.now},dateRecipientValidated:{type:Date},dateUnsubscribed:{type:Date},unsubscriptionReason:{type:String},dateRemoved:{type:Date}});c.pre("validate",function(e){console.log("Called pre save recipient"),this.recipientId||(this.recipientId=(0,i.idier)()),e()}),c.pre("save",!0,function(e,t){this.dateUpdated=new Date,e(),t()}),c.pre("save",!0,function(e,t){var n=[],s=(0,a.appraiseEmail)(this.email);s.length>0&&(this.invalidate("email",s.join(", ")),n.push(s.join(", ")));var o=(0,a.appraiseDisplayName)(this.displayName);o.length>0&&(this.invalidate("displayName",o.join(", ")),n.push(o.join(" "))),n.length>0&&t(new Error(n.join(" "))),e(),t()}),c.set("toJSON",{transform:function(e,t){return{recipientId:t.recipientId,email:t.email,displayName:t.displayName,dateCreated:t.dateCreated,dateUnsubscribed:t.dateUnsubscribed,status:t.status}}}),c.statics.findOneRecipient=function(e){return this.findOne({recipientId:e}).exec()},c.statics.update=function(e,t,n){return this.findOne({recipientId:e,ownerAccountId:t}).exec().then(function(e){var t=e,s=Object.keys(n);return s.forEach(function(e){t[e]=n[e]}),t.save()})},c.statics.findOneByEmail=function(e){return this.findOne({email:e}).exec()},c.statics.findAllForId=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return t?this.find({ownerAccountId:e}).lean().exec():this.find({ownerAccountId:e}).exec()},c.statics.totalForAccountId=function(e){return this.count({ownerAccountId:e}).exec()};var d=r.default.model("Recipient",c);t.Recipient=d,t.RecipientStatus=u},function(e,t,n){"use strict";function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.PostController=t.Post=t.postRoutes=void 0;var r=n(32),a=o(r),i=n(34),u=o(i),c=n(33),d=s(c);t.postRoutes=a.default,t.Post=u.default,t.PostController=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=n(3),o=n(33),r=n(22),a=new s.Router;a.get("/posts",(0,r.ensureLoggedIn)(),o.getPostsEndpoint),a.post("/posts",(0,r.ensureLoggedIn)(),o.addPostEndpoint),a.put("/posts/:postId",(0,r.ensureLoggedIn)(),o.updatePostEndpoint),a.delete("/posts/:postId",(0,r.ensureLoggedIn)(),o.removePostEndpoint),t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.removePostEndpoint=t.updatePostEndpoint=t.addPostEndpoint=t.getPostsEndpoint=void 0;var s=n(34),o=function(e){var t=e.user,n=e.body.onBehalfOfId;return n&&n.length>0&&t&&t.canActOnBehalfOf(n)?n:e.user&&e.user.accountId?e.user.accountId:null},r=function(e,t){var n=o(e);n||(t.statusMessage="No accountId provided",t.status(422).end()),s.Post.findAllForId(n,!1).then(function(e){var n=e.map(function(e){return e.toJSON()});t.status(200).json({success:!0,posts:n})}).catch(function(e){t.statusMessage=e.message,t.status(404).end()})},a=function(e,t){var n=o(e);n||(t.statusMessage="No accountId provided",t.status(422).end());var r=e.body,a=r.message,i=r.subject,u=r.mediaIds,c=r.status,d=new s.Post({message:a,subject:i,mediaIds:u,status:c,ownerAccountId:n});d.save().then(function(e){var n=e.toJSON();t.status(201).json({success:!0,message:"Successfully created post",recipient:n})}).catch(function(e){var n="Post could not be created.";11e3===e.code?n="Post already exists":e.message&&(n=e.message),t.statusMessage=n,t.status(422).end()})},i=function(e,t){var n=o(e);n||(t.statusMessage="No accountId provided",t.status(422).end());var r=e.params.postId;e.body.postId&&(r=e.body.postId),r||t.status(422).json({success:!1,messages:"No PostId provided."});var a=e.body,i=a.message,u=a.subject,c=a.mediaIds,d=a.status,p={};i&&i.length>0&&(p.message=i),u&&u.length>0&&(p.subject=u),c&&c.length>0&&(p.mediaIds=c),d&&d.length>0&&(p.status=d),0===Object.keys(p).length&&t.status(422).json({success:!1,messages:"Nothing to update."}),s.Post.update(r,n,p).then(function(e){t.status(200).json({success:!0,message:"Successfully updated post",post:e.toJSON()})}).catch(function(e){var n="Post could not be updated.";e.message&&(n=e.message),t.statusMessage=n,t.status(422).end()})},u=function(e,t){var n=o(e);n||(t.statusMessage="No accountId provided",t.status(422).end());var r=e.params.postId;e.body.postId&&(r=e.body.postId),r||(t.statusMessage="No postId provided.",t.status(422).end()),s.Post.update(r,n,{status:s.PostStatus.REMOVED}).then(function(){t.status(204).end()}).catch(function(e){var n="Post could not be removed.";e.message&&(n=e.message),t.statusMessage=n,t.status(422).end()})};t.getPostsEndpoint=r,t.addPostEndpoint=a,t.updatePostEndpoint=i,t.removePostEndpoint=u},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.PostStatus=t.Post=void 0;var o=n(12),r=s(o),a=n(16),i=100,u={DRAFT:"draft",POSTED:"posted",REMOVED:"removed"},c=new o.Schema({status:{type:o.Schema.Types.String,default:u.POSTED,enum:[u.DRAFT,u.POSTED,u.REMOVED]},postId:{type:o.Schema.Types.Number,unique:!0,required:!0},message:{type:o.Schema.Types.String,required:!0},subject:{type:o.Schema.Types.String},mediaIds:{type:o.Schema.Types.Array},ownerAccountId:{type:o.Schema.Types.Number,required:!0,index:!0},dateCreated:{type:Date,default:Date.now},dateUpdated:{type:Date,default:Date.now}});c.pre("validate",function(e){this.postId||(this.postId=(0,a.idier)()),e()}),c.pre("save",!0,function(e,t){this.dateUpdated=new Date,e(),t()}),c.set("toJSON",{transform:function(e,t){return{postId:t.postId,message:t.message,subject:t.subject,mediaIds:t.mediaIds,ownerAccountId:t.ownerAccountId,dateCreated:t.dateCreated,dateUpdated:t.dateUpdated,status:t.status}}}),c.statics.findOnePost=function(e){return this.findOne({postId:e}).exec()},c.statics.update=function(e,t,n){return this.findOne({postId:e,ownerAccountId:t}).exec().then(function(e){var t=e,s=Object.keys(n);return s.forEach(function(e){t[e]=n[e]}),t.save()})},c.statics.findAllForId=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,n=arguments[2],s=t;return s>i&&(s=i),n?this.find({ownerAccountId:e,postId:{$lte:n}}).limit(s).sort({postId:-1}).exec():this.find({ownerAccountId:e}).limit(s).sort({postId:-1}).exec()},c.statics.totalForAccountId=function(e){return this.count({ownerAccountId:e}).exec()};var d=r.default.model("Post",c);t.Post=d,t.PostStatus=u},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}var o=n(36),r=s(o),a=n(37),i=s(a);process.env.NODE_ENV&&"production"!==process.env.NODE_ENV?r.default.load():r.default.load(),(0,i.default)(["REDIS_URL","MONGODB_URI","API_SERVER_PORT","MAIN_SERVER_PORT","ACCOUNT_PEPPER_1","ACCOUNT_ENCRYPT_CURRENT_PEPPER","IDIER_WORKER_ID"])},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("require-environment-variables")},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(12),r=s(o),a=process.env.MONGODB_URI,i={server:{socketOptions:{keepAlive:3e5,connectTimeoutMS:3e4}},replset:{socketOptions:{keepAlive:3e5,connectTimeoutMS:3e4}}};r.default.Promise=global.Promise,r.default.connect(a,i),r.default.connection.once("open",function(){return console.log("Connected to MongoDb: running on "+a)}).on("error",function(e){return console.warn("Warning",e)}),t.default=r.default},function(e,t,n){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(40),r=s(o),a=process.env.REDIS_URL,i=r.default.createClient(a);i.on("error",function(e){console.log("Redis connection error "+e)}),t.default=i},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("connect-redis")}]);
//# sourceMappingURL=server.js.map